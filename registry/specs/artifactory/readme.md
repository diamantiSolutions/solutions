
# Deploying Jfrog Artifactory Docker Registry on Diamanti


##setup namespace
1.0. We will be running registry on separate namespace to keep isolation from other project.
```
kubectl create namespace registry-artifactory
```

2.0. Create postgresSQL storage and setup postgresSQL, which will be further used by artifactory.
```
$ kubectl apply -f postgresql-storage.yaml
$ kubectl apply -f postgresql.yaml
```

3.0. Create artifactory storage. Please note that this example is using dynamic persistent volume, but for better manageability and easy recovery of volume after disaster, it is recommended to use statically created persistent volume. Also to make this solutions Highly avaialble, setup storage with mirrorcount more than 1. (Not covered in this example)
```
$ kubectl apply -f artifactory-storage.yaml
```

4.0. create Artifactory deployment  and services.
```
$ kubectl apply -f artifactory.yaml

```

7.0. Setup nginx for reverse proxy and SSL termination

7.1. create tls secrete for nginx:
```
kubectl create secret tls -n registry-artifactory art-tls --cert=/home/diamanti/registry-tls/jfrog-tls/registry.crt --key=/home/diamanti/registry-tls/jfrog-tls/registry.key

```

7.2.  Storage and deployment
```
$ kubectl apply -f nginx-storage.yaml
$ kubectl apply -f nginx-deployment.yaml
```

7.3  Start nginx service 
```
$ kubectl apply -f nginx-service.yaml
```


8.0. Setup artifactory

8.1. Access the dashboard.
 It will take a while for Artifactory to get ready. You can use following cmd to know when it's done configuring.
```

ART_POD_NAME=$(kubectl get pods -n registry-artifactory -l app=artifactory-pro  | grep artifactory-deployment | cut -d' ' -f1)

while true ; do
	printf "." 
	result=$(kubectl logs -f ${ART_POD_NAME} -n registry-artifactory  | grep -c 'Artifactory successfully started .* seconds') # 
	if [ $result  -eq 1 ] ; then
	    echo " Artifactory is  up and running!"
	    break
	fi
	sleep 5
    done

```

8.2. Find the IP address of the nginx  service or artifactory directly as follows
```
$ kubectl get pods -o wide -n registry-artifactory
NAME                                                 READY     STATUS    RESTARTS   AGE       IP             NODE
artifactory-deployment-77dfd4c575-pds55              1/1       Running   1          1h        172.16.137.5   appserv94
nginx-artifactory-deployment-58ffc54fd7-r45g7        1/1       Running   0          59m       172.16.137.6   appserv96
postgresql-artifactory-deployment-75976fd7cc-747fz   1/1       Running   0          1h        172.16.137.4   appserv94

```

8.3 Go to the http://<nginx-IP-Address> or http://<artifactory-IP-address>:8081  to access the dashboard. When prompted enter the licence information obtained from jfrog.

8.4. Set following  by going to admin->HTTP Settings

```
Docker Access Method
Repository Path

Server Provider
Nginx

Internal Hostname  
artifactory
 
Internal Port 
8081
Internal Context Path  
artifactory
 
Upstream Name 
artifactory

Public Server Name  
proxy.registry-artifactory.svc.solutions.eng.diamanti.com
 
Public Context Path  
<blank>

<select> Use HTTP
HTTP Port 
80

<select> Use HTTPS
HTTPS Port 
443

SSL Key Path  
/var/opt/jfrog/nginx/ssl/tls.key
 
SSL Certificate Path  
/var/opt/jfrog/nginx/ssl/tls.crt
```

Please note that filling and saving above form will automatically update the configuration of nginx pod. Following nginx configuration is just for information purpose and it will be auto configured in nginx service when clicking "save" in previous step.
```

###########################################################
## this configuration was generated by JFrog Artifactory ##
###########################################################

## add ssl entries when https has been set in config
ssl_certificate      /var/opt/jfrog/nginx/ssl/tls.crt;
ssl_certificate_key  /var/opt/jfrog/nginx/ssl/tls.key;
ssl_session_cache shared:SSL:1m;
ssl_prefer_server_ciphers   on;
## server configuration
server {
    listen 443 ssl;
    listen 80 ;
    
    server_name *.proxy.registry-artifactory.svc.solutions.eng.diamanti.com proxy.registry-artifactory.svc.solutions.eng.diamanti.com;
    
    if ($http_x_forwarded_proto = '') {
        set $http_x_forwarded_proto  $scheme;
    }
    ## Application specific logs
    ## access_log /var/log/nginx/proxy.registry-artifactory.svc.solutions.eng.diamanti.com-access.log timing;
    ## error_log /var/log/nginx/proxy.registry-artifactory.svc.solutions.eng.diamanti.com-error.log;
    rewrite ^/$ /webapp/ redirect;
    rewrite ^//?(/webapp)?$ /webapp/ redirect;
    rewrite ^/(v2)/(.*) /$1/$2;
    chunked_transfer_encoding on;
    client_max_body_size 0;
    location / {
    proxy_read_timeout  900;
    proxy_pass_header   Server;
    proxy_cookie_path   ~*^/.* /;
    if ( $request_uri ~ ^/(.*)$ ) {
        proxy_pass          http://artifactory:8081/artifactory/$1;
    }
    proxy_pass          http://artifactory:8081/artifactory/;
    proxy_set_header    X-Artifactory-Override-Base-Url $http_x_forwarded_proto://$host:$server_port;
    proxy_set_header    X-Forwarded-Port  $server_port;
    proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header    Host              $http_host;
    proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    }
}

```

9.0. Accessing repository
```
$ kubectl create -f ../test/docker-testpod.yaml
pod "docker-dind" created

[diamanti@appserv94 ~]$  kubectl exec -it docker-dind -c docker sh

/ # docker pull busybox:latest

/ # docker tag busybox:latest proxy.registry-artifactory.svc.solutions.eng.diamanti.com/docker/busybox:latest


/ # docker login proxy.registry-artifactory.svc.solutions.eng.diamanti.com
Username: admin
Password:
Login Succeeded

/ # docker push  proxy.registry-artifactory.svc.solutions.eng.diamanti.com/docker/busybox:latest
The push refers to repository [proxy.registry-artifactory.svc.solutions.eng.diamanti.com/docker/busybox]
c5183829c43c: Pushed
latest: digest: sha256:c7b0a24019b0e6eda714ec0fa137ad42bc44a754d9cea17d14fba3a80ccc1ee4 size: 527
/ #


```

10.0 Original tutorial from jfrog for this can be found at:

https://github.com/JFrogDev/artifactory-docker-examples/tree/master/kubernetes



11.0. Debug

 11.1. Following is needed in nginx.conf to make long name of dns work:
```
http {
..
server_names_hash_bucket_size 1024;
..
```


11.2 Enabling log format for upstream in nginx.conf:
```
  log_format upstream_logging '[$time_local] $remote_addr - $remote_user - $server_name to: $upstream_addr: ($request_uri) $request upstream_response_time $upstream_response_time msec $msec request_time $request_time';
#to use log format 
access_log  /var/log/nginx/access.log  upstream_logging;
```



# TO DO:
1.0. HA setup
2.0. Deployment with helm.


